---
import Layout from '../layouts/Layout.astro';
import PocketBase from 'pocketbase';

// Configuration PocketBase (local)
const pb = new PocketBase('http://127.0.0.1:8090');

// RÃ©cupÃ©rer les projets
let projets = [];
try {
	projets = await pb.collection('projets').getFullList({
		filter: 'afficher = true',
		sort: 'ordre_affichage,date_realisation'
	});
} catch (error) {
	console.error('Erreur lors de la rÃ©cupÃ©ration des projets:', error);
}
---

<Layout title="Mes Projets - Enzo Locatelli" description="DÃ©couvrez mes projets de design graphique et dÃ©veloppement web">
	<!-- Hero Section -->
	<section id="projets-hero" class="min-h-screen flex items-center px-4 py-20">
		<div class="max-w-7xl mx-auto w-full">
			<!-- Titre principal -->
			<div class="text-center mb-20 scroll-reveal">
				<h1 class="text-5xl md:text-6xl lg:text-7xl font-bold mb-6">
					<span class="text-white">MES </span><span class="neon-pink">PROJETS</span>
				</h1>
				<p class="text-xl md:text-2xl text-gray-300 max-w-3xl mx-auto">
					Explorez mes rÃ©alisations en design graphique, dÃ©veloppement web et communication digitale
				</p>
			</div>

			<!-- Filtres -->
			<div class="flex justify-center gap-4 mb-16 scroll-reveal flex-wrap">
				<button class="filter-btn active" data-filter="all">
					Tous les projets
				</button>
				<button class="filter-btn" data-filter="design">
					Design
				</button>
				<button class="filter-btn" data-filter="web">
					DÃ©veloppement Web
				</button>
				<button class="filter-btn" data-filter="communication">
					Communication
				</button>
				<button class="filter-btn" data-filter="video">
					VidÃ©o
				</button>
			</div>

			<!-- Carrousel 3D -->
			<div class="carousel-3d-container scroll-reveal">
				<div id="carousel-3d" class="carousel-3d">
					{projets.map((projet, index) => {
						const imageUrl = `http://127.0.0.1:8090/api/files/${projet.collectionId}/${projet.id}/${projet.photo_principale}`;
						
						return (
							<div 
								class="carousel-item" 
								data-type={projet.type}
								data-index={index}
							>
								<div class="project-card">
									<!-- Image du projet -->
									<div class="project-image">
										<img 
											src={imageUrl} 
											alt={projet.nom}
											loading="lazy"
										/>
										<div class="project-overlay">
											<div class="project-type-badge">
												{projet.type === 'design' && 'ðŸŽ¨ Design'}
												{projet.type === 'web' && 'ðŸ’» Web'}
												{projet.type === 'communication' && 'ðŸ“± Communication'}
												{projet.type === 'video' && 'ðŸŽ¬ VidÃ©o'}
												{projet.type === 'autre' && 'âœ¨ Autre'}
											</div>
										</div>
									</div>

									<!-- Contenu de la carte -->
									<div class="project-content">
										<h3 class="project-title">{projet.nom}</h3>
										<p class="project-description">{projet.description_courte}</p>
										
										{projet.technologies && projet.technologies.length > 0 && (
											<div class="project-tags">
												{projet.technologies.slice(0, 3).map((tech: string) => (
													<span class="tag">{tech}</span>
												))}
											</div>
										)}

										<a 
											href={`/projets/${projet.slug}`} 
											class="project-btn btn btn-primary btn-sm btn-neon"
										>
											Voir le projet
											<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
												<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
											</svg>
										</a>
									</div>
								</div>
							</div>
						);
					})}
				</div>

				<!-- ContrÃ´les du carrousel -->
				<div class="carousel-controls">
					<button id="prev-btn" class="carousel-control-btn">
						<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
						</svg>
					</button>
					<button id="next-btn" class="carousel-control-btn">
						<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
						</svg>
					</button>
				</div>

				<!-- Indicateurs -->
				<div class="carousel-indicators" id="carousel-indicators">
					{projets.map((_, index) => (
						<button 
							class={`indicator ${index === 0 ? 'active' : ''}`}
							data-index={index}
						></button>
					))}
				</div>
			</div>

			<!-- Message si pas de projets -->
			{projets.length === 0 && (
				<div class="text-center py-20">
					<p class="text-gray-400 text-xl">Aucun projet Ã  afficher pour le moment.</p>
				</div>
			)}
		</div>
	</section>
</Layout>

<script>
	import PocketBase from 'pocketbase';

	// Animation au scroll
	const observerOptions = {
		threshold: 0.1,
		rootMargin: '0px 0px -100px 0px'
	};

	const observer = new IntersectionObserver((entries) => {
		entries.forEach(entry => {
			if (entry.isIntersecting) {
				entry.target.classList.add('animate-fade-in');
				observer.unobserve(entry.target);
			}
		});
	}, observerOptions);

	document.addEventListener('DOMContentLoaded', () => {
		const elements = document.querySelectorAll('.scroll-reveal');
		elements.forEach(el => observer.observe(el));

		// Initialisation du carrousel 3D
		initCarousel3D();

		// Gestion des filtres
		initFilters();
	});

	function initCarousel3D() {
		const carousel = document.getElementById('carousel-3d');
		const items = document.querySelectorAll('.carousel-item');
		const prevBtn = document.getElementById('prev-btn');
		const nextBtn = document.getElementById('next-btn');
		const indicators = document.querySelectorAll('.indicator');
		
		if (!carousel || items.length === 0) return;

		let currentIndex = 0;
		let isAnimating = false;
		const totalItems = items.length;
		const angleIncrement = 360 / totalItems;
		const radius = 600; // Rayon du cylindre

		function updateCarousel(animated = true) {
			if (isAnimating && animated) return;
			if (animated) isAnimating = true;

			items.forEach((item, index) => {
				const angle = angleIncrement * (index - currentIndex);
				const radians = (angle * Math.PI) / 180;
				
				const x = Math.sin(radians) * radius;
				const z = Math.cos(radians) * radius - radius;
				
				// Calculer l'opacitÃ© et l'Ã©chelle basÃ©es sur la position
				const opacity = Math.cos(radians) * 0.5 + 0.5; // 0.5 Ã  1
				const scale = Math.cos(radians) * 0.3 + 0.7; // 0.7 Ã  1
				
				(item as HTMLElement).style.transform = `
					translateX(${x}px) 
					translateZ(${z}px) 
					rotateY(${-angle}deg)
					scale(${scale})
				`;
				(item as HTMLElement).style.opacity = opacity.toString();
				(item as HTMLElement).style.zIndex = Math.round(z).toString();

				// Activer/dÃ©sactiver les interactions
				if (index === currentIndex) {
					item.classList.add('active');
					(item as HTMLElement).style.pointerEvents = 'auto';
				} else {
					item.classList.remove('active');
					(item as HTMLElement).style.pointerEvents = 'none';
				}
			});

			// Mettre Ã  jour les indicateurs
			indicators.forEach((indicator, index) => {
				if (index === currentIndex) {
					indicator.classList.add('active');
				} else {
					indicator.classList.remove('active');
				}
			});

			if (animated) {
				setTimeout(() => {
					isAnimating = false;
				}, 600);
			}
		}

		function next() {
			currentIndex = (currentIndex + 1) % totalItems;
			updateCarousel();
		}

		function prev() {
			currentIndex = (currentIndex - 1 + totalItems) % totalItems;
			updateCarousel();
		}

		function goToSlide(index: number) {
			currentIndex = index;
			updateCarousel();
		}

		// Event listeners
		if (prevBtn) prevBtn.addEventListener('click', prev);
		if (nextBtn) nextBtn.addEventListener('click', next);

		indicators.forEach((indicator, index) => {
			indicator.addEventListener('click', () => goToSlide(index));
		});

		// Navigation au clavier
		document.addEventListener('keydown', (e) => {
			if (e.key === 'ArrowLeft') prev();
			if (e.key === 'ArrowRight') next();
		});

		// Auto-rotation (optionnel - commentÃ© par dÃ©faut)
		// let autoRotate = setInterval(next, 5000);
		// carousel.addEventListener('mouseenter', () => clearInterval(autoRotate));
		// carousel.addEventListener('mouseleave', () => autoRotate = setInterval(next, 5000));

		// Position initiale
		updateCarousel(false);
	}

	function initFilters() {
		const filterBtns = document.querySelectorAll('.filter-btn');
		const carouselItems = document.querySelectorAll('.carousel-item');

		filterBtns.forEach(btn => {
			btn.addEventListener('click', () => {
				const filter = (btn as HTMLElement).dataset.filter;

				// Activer le bouton
				filterBtns.forEach(b => b.classList.remove('active'));
				btn.classList.add('active');

				// Filtrer les projets
				carouselItems.forEach(item => {
					const type = (item as HTMLElement).dataset.type;
					
					if (filter === 'all' || type === filter) {
						(item as HTMLElement).style.display = 'block';
					} else {
						(item as HTMLElement).style.display = 'none';
					}
				});

				// RÃ©initialiser le carrousel aprÃ¨s filtrage
				setTimeout(() => {
					initCarousel3D();
				}, 100);
			});
		});
	}
</script>

<style>
	/* Styles pour la page projets */
	.scroll-reveal {
		opacity: 0;
		transform: translateY(30px);
		transition: opacity 0.8s ease, transform 0.8s ease;
	}

	.scroll-reveal.animate-fade-in {
		opacity: 1;
		transform: translateY(0);
	}

	/* Filtres */
	.filter-btn {
		padding: 0.75rem 1.5rem;
		background: rgba(255, 255, 255, 0.05);
		border: 1px solid rgba(208, 25, 208, 0.3);
		border-radius: 0.75rem;
		color: #fff;
		font-size: 0.95rem;
		cursor: pointer;
		transition: all 0.3s ease;
	}

	.filter-btn:hover {
		background: rgba(208, 25, 208, 0.2);
		border-color: #D019D0;
		transform: translateY(-2px);
	}

	.filter-btn.active {
		background: #D019D0;
		border-color: #D019D0;
		box-shadow: 0 0 20px rgba(208, 25, 208, 0.5);
	}

	/* Conteneur du carrousel 3D */
	.carousel-3d-container {
		position: relative;
		width: 100%;
		height: 700px;
		perspective: 1500px;
		margin-top: 3rem;
	}

	.carousel-3d {
		position: relative;
		width: 100%;
		height: 100%;
		transform-style: preserve-3d;
	}

	/* Items du carrousel */
	.carousel-item {
		position: absolute;
		width: 450px;
		height: 600px;
		left: 50%;
		top: 50%;
		margin-left: -225px;
		margin-top: -300px;
		transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
		transform-style: preserve-3d;
	}

	.carousel-item.active {
		z-index: 100 !important;
	}

	/* Carte du projet */
	.project-card {
		width: 100%;
		height: 100%;
		background: linear-gradient(135deg, rgba(31, 41, 55, 0.8), rgba(0, 0, 0, 0.8));
		border-radius: 1.5rem;
		overflow: hidden;
		border: 2px solid rgba(208, 25, 208, 0.3);
		box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
		transition: all 0.3s ease;
		display: flex;
		flex-direction: column;
	}

	.carousel-item.active .project-card {
		border-color: #D019D0;
		box-shadow: 0 0 40px rgba(208, 25, 208, 0.4), 0 20px 60px rgba(0, 0, 0, 0.5);
	}

	/* Image du projet */
	.project-image {
		position: relative;
		width: 100%;
		height: 60%;
		overflow: hidden;
		background: linear-gradient(135deg, #1f2937, #111827);
	}

	.project-image img {
		width: 100%;
		height: 100%;
		object-fit: cover;
		transition: transform 0.5s ease;
	}

	.carousel-item.active .project-image img:hover {
		transform: scale(1.05);
	}

	.project-overlay {
		position: absolute;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background: linear-gradient(to bottom, rgba(0, 0, 0, 0) 0%, rgba(0, 0, 0, 0.7) 100%);
		display: flex;
		align-items: flex-start;
		justify-content: flex-end;
		padding: 1.5rem;
	}

	.project-type-badge {
		background: rgba(208, 25, 208, 0.9);
		color: white;
		padding: 0.5rem 1rem;
		border-radius: 0.5rem;
		font-size: 0.875rem;
		font-weight: 600;
		backdrop-filter: blur(10px);
	}

	/* Contenu de la carte */
	.project-content {
		padding: 1.5rem;
		flex: 1;
		display: flex;
		flex-direction: column;
		gap: 1rem;
	}

	.project-title {
		font-size: 1.5rem;
		font-weight: 700;
		color: #fff;
		margin: 0;
		background: linear-gradient(90deg, #D019D0, #1974D1);
		-webkit-background-clip: text;
		-webkit-text-fill-color: transparent;
		background-clip: text;
	}

	.project-description {
		color: #d1d5db;
		font-size: 0.95rem;
		line-height: 1.6;
		flex: 1;
		overflow: hidden;
		display: -webkit-box;
		-webkit-line-clamp: 3;
		-webkit-box-orient: vertical;
	}

	.project-tags {
		display: flex;
		gap: 0.5rem;
		flex-wrap: wrap;
	}

	.tag {
		background: rgba(25, 116, 209, 0.2);
		color: #1974D1;
		padding: 0.25rem 0.75rem;
		border-radius: 0.5rem;
		font-size: 0.75rem;
		font-weight: 500;
		border: 1px solid rgba(25, 116, 209, 0.3);
	}

	.project-btn {
		width: 100%;
		display: flex;
		align-items: center;
		justify-content: center;
		gap: 0.5rem;
	}

	/* ContrÃ´les du carrousel */
	.carousel-controls {
		position: absolute;
		top: 50%;
		left: 0;
		right: 0;
		transform: translateY(-50%);
		display: flex;
		justify-content: space-between;
		padding: 0 2rem;
		pointer-events: none;
		z-index: 200;
	}

	.carousel-control-btn {
		pointer-events: auto;
		width: 3.5rem;
		height: 3.5rem;
		border-radius: 50%;
		background: rgba(208, 25, 208, 0.2);
		border: 2px solid rgba(208, 25, 208, 0.5);
		color: #D019D0;
		display: flex;
		align-items: center;
		justify-content: center;
		cursor: pointer;
		transition: all 0.3s ease;
		backdrop-filter: blur(10px);
	}

	.carousel-control-btn:hover {
		background: rgba(208, 25, 208, 0.4);
		border-color: #D019D0;
		transform: scale(1.1);
		box-shadow: 0 0 20px rgba(208, 25, 208, 0.5);
	}

	/* Indicateurs */
	.carousel-indicators {
		position: absolute;
		bottom: -3rem;
		left: 50%;
		transform: translateX(-50%);
		display: flex;
		gap: 0.75rem;
		z-index: 200;
	}

	.indicator {
		width: 0.75rem;
		height: 0.75rem;
		border-radius: 50%;
		background: rgba(255, 255, 255, 0.3);
		border: none;
		cursor: pointer;
		transition: all 0.3s ease;
	}

	.indicator:hover {
		background: rgba(208, 25, 208, 0.5);
		transform: scale(1.2);
	}

	.indicator.active {
		background: #D019D0;
		width: 2rem;
		border-radius: 0.5rem;
		box-shadow: 0 0 10px rgba(208, 25, 208, 0.5);
	}

	/* Responsive */
	@media (max-width: 768px) {
		.carousel-3d-container {
			height: 600px;
		}

		.carousel-item {
			width: 350px;
			height: 500px;
			margin-left: -175px;
			margin-top: -250px;
		}

		.carousel-controls {
			padding: 0 1rem;
		}

		.carousel-control-btn {
			width: 3rem;
			height: 3rem;
		}
	}

	@media (max-width: 480px) {
		.carousel-3d-container {
			height: 550px;
		}

		.carousel-item {
			width: 300px;
			height: 450px;
			margin-left: -150px;
			margin-top: -225px;
		}
	}
</style>
